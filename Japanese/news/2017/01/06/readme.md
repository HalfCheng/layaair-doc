#Webviewのカーネルに微信IOSクライアントが全面的にアップグレードし、HTML 5の性能は4倍に向上します。

2017-01-06

前回のWeChat AndroidのX 5 Blinkカーネルへのアップグレード性能と互換性の問題が解決された後、2017年1月6日夜、WeChat IOSは重大な良好なメッセージを発表しました。非技術開発者にとって、この言葉は何を表していますか？Layabox小编はまず解答を投げて、ゆっくりと読みます。

前回のWeChat AndroidのX 5 Blinkカーネルへのアップグレード性能と互換性の問題が解決された後、2017年1月6日夜、WeChat IOSは重大な良好なメッセージを発表しました。非技術開発者にとって、この言葉は何を表していますか？Layabox小编はまず解答を投げて、ゆっくりと読みます。

**進級後のメリット**

>**一、HTML 5レンダリング性能は4倍向上します。**
>
>**二、メモリの占有は30%まで減少する。**

小编は技术兄からの性能テストリンクを比较したところ、现在のマイクロコアUICWebViewとSafariのWKWebviewのカーネル性能の差は4倍ほどになった。メモリの占有率は30%以下になります。WeChat IOSクライアントがWKWebviewにアップグレードした後に使うのはSafariの現在のWKWebviewカーネルです。**これはHTML 5の大規模なゲームの開発者にとって大きなニュースです。未来HTML 5ゲームは簡単にAPPゲームの効果を実現できます。**

**更新時間**

WeChat iOSクライアントは2017年3月1日までに徐々にWKWebviewカーネルにアップグレードする。

#### **背景**

WKWebViewは、アップルがiOS 8に導入した新しいコンポーネントで、最新のWebkit機能をサポートする現代のウェブブラウズコントロールを提供することを目的として、過去のUICWebViewの古い、古い、愚か、特にメモリの使用量が大きな問題となっています。これはSafariと同じNitro JavaScriptエンジンを使って、ページjsの実行速度を大幅に高めました。

####切り替え方法

iOS Webviewは6.5.3バージョンから開発者が手動でWKWebviewとUICWebviewを切り替え、開発者がWKWebviewに事前に適応できるようになりました。

**入り口を手動で切り替える:**

WeChatセッションリストページで右上の「プラスボタン」をクリックし、メニューの「友達追加」を選択し、友達インターフェースを追加した検索ボックスに文字列を入力します。「：switch web」をクリックし、キーボードの右下の検索ボタンをクリックします。切り替えが成功したら、現在使用されているカーネルはUICWebviewかWKWebviewかを提示します。

**検証切替方法:**

コマンドを使ってWKWebviewに切り替えた後、現在のウェブサイトがWKWebviewカーネルであるかどうかを以下の方法で検証することができます。

WeChat内の任意の入り口は任意のページに入り、ページのローディングが成功したら下にページ（またはページ右上のメニューボタンをクリックして）を引き、アドレスバーを表示させます。アドレスバーが「このページは」で始まると、現在WKWebviewが使われています。「ページは」で使うUICWebviewです。

**ページはどうやって現在使っているwebviewのカーネルを判断しますか？**

ページではWeChatによって注入されたwindow.uuuwxjs変数から現在使用されているwebviewカーネルを判断できます。iOS WeChat 6.5.3以降のバージョンwindow.uuuwxjsがtrueの場合はWKWebviewを使用し、falseまたは「undefine」の場合はUnibviewです。

**先端が注目のポイントにマッチしています。**

適合の主な原則：WKWebviewの新しい特性の新しい行為か、それともWebviewの内部ロジックかを区別できないと、テストページを使ってSafariとWeChatのWKWebview内核でそれぞれテストし、問題発生の原因を迅速に位置決めすることができます。

####適合マニュアル

WKWebviewに切り替えた後、Webviewの行為はSafariと非常に一致しています。唯一の違いはWebviewにはWeChat JSBridgeに関するスクリプトが注入されます。したがって、適切なポイントは以下の点に注目する必要があります。

>一：ページ機能は正常ですか？
>
>二：ページ画面の適合は正常かどうか三：ページの動作は正常かどうか（例えば、ユーザがページを閲覧するときに戻るボタンをクリックして前のページに戻るときのページ論理は正常かどうか）
>
>四：ページで使用する文法は互換性がありますか？
>
>五：JSSAPIは正常で完璧な仕事をしていますか？
>
>六：CookieやLocastrageなどの関連ロジックが正常かどうかに重点を置いています。
>
>七：もしサーバがCache-Coontrolキャッシュに戻る有効時間を設定しているなら、関連ロジックが正常かどうかを確認する必要があります。

通常の状況では、あなたのページは特別な適合をする必要はありませんが、もしあなたのページが以下のいくつかの影響を受けるロジックに関連しているなら、適切なアドバイスによって適応と確認を行う必要があります。

JSAPI関連適配

もうcacheをサポートしません。

変化：WKWebviewではcache jsapiはしばらくサポートされていません。

このアプリを使ったすべての開発者はページ関連のロジックを削除することができます。

二：ページはLocal IDで画像をプレビューします。

変化：choseImage appiを使用して戻るlocal ldはもうサポートされません。例えば、「crc=wxLocarrource:/5011465920332」のように画像をプレビューします。

適合提案：

\1.iOS WeChat 6.5.3バージョンおよび以降のバージョンでは、追加されたjsapi：get LocalImgDataを使ってLocalIDに対応するピクチャbase 64を符号化してフロントページに表示します。

\2.ページを紹介してJSSDKを導入したら、直接JSSDKを1.2.0の最新バージョンにアップグレードすれば、ページの自動適応に役立ちます。（現在のJSSD K線のバージョンは1.0.0と1.1.0で、更新バージョンは1.2.0で、[https:/res.wx.qq.com/open/js/jweixin-1.2.0.js]（）

三：JSSDKを使用し、wx.com figを使用した権限授権があります。jsapi呼び出しの失敗問題に注目してください。

変更：WKWebviewの内部実装変更により、WeChat内のページjsapiの権限管理に一定の論理的な調整を行いました。以前に許可された正常なjsapi取得権限が異常になる可能性が極めて小さいため、jsapiの呼び出しに失敗しました。

適合提案：

1.iOS Webviewこのバージョンでは、HTML 5のHistory API pustateを使用し、popstate;replaccestateなどのコントロールページナビゲーション（典型的なアプリケーションページのようなもの）を使用し、JSSDKのwx.com figをJsapiとして承認した場合、大きな確率でjsapiが発生します。6.5.1ページが可能であれば、この問題はAncher hash技術をHistory技術に置き換えて解決できます。

2.iOS WeChat 6.5.2以降のバージョンでは、上記の問題はありませんが、historyやhash技術でページナビゲーションアドレスを変更したページがあることを100%確認することはできません。

CookieとLocastrageの設定について

一：WeChatアカウントを終了したら、すべてのCookieとLocastrageをクリアします。

二：ページ機能はCookieに依存しています。またはCookieに関連する関連ロジックがあります。

変更：WKWebview内部で変更が実現されると、現在のページCookieに関するロジック、例えば、ドメインをまたいでCookieとページにアクセスするリソースやピクチャストアサーバがCookieをチェックしてデータを返すなどの状況に影響します。

問題の説明：あるページAにアクセスする時、ページAが別のページBのリソース（ページAとBは異なるドメイン名）を引用したら、ページBは第三者ページと見なされる。ページBにCookieを設定すると、WKWebviewに命中し、第三者がドメインをまたいでCookieを設定するセキュリティポリシーを阻止し、問題が発生します。

適合提案：

WKWebviewでは、デフォルトではドメイン横断を阻止する第三者がCookieを設定します。Cookieを通じて伝達されたすべての情報は、サービスバックグラウンドを通じて伝達すべき情報を格納し、ページに格納された情報に対応するaccesst＿kenにパスワードを加えて、そしてUrlを介して自身の業務に参加するaccessatokenによってページ間情報を転送することができる。

ページのリソースや画像が格納されているサーバがチェックCookieに依存してデータを返している場合、WKWebviewに切り替えた後、マイクロメッセージ内で長押しして保存したり、プレビュー大図をクリックした場合、設定されたCookieを完全にバンドしないと、ピクチャの保存に失敗したり、前覧に失敗したりします。この場合を除いて、開発者は他の状況ではCookieがなくなってしまうことを心配しなくてもいいです。すべての要求は完全なCookieを持参します。

動画リスト

変更：iOS WeChat 6.5.3以降のバージョンでは、Webviewデフォルトでは小窓再生に対応しています。

開発者は特に注意しなければならない。小窓再生には先端が必要で、iOS 10とiOS 10以下の低バージョンを同時に適応させる必要がある。



WKWebviewページの挙動はSafariと完全に一致しており、UICWebviewページの行動に依存するページの論理が失効したり、異常が発生することがあります。

一：SafariまたはWebviewのページAはページBにジャンプしてページAに戻ります。ScriptとAjaxは再実行されません。

二：SafariまたはWebviewでは、ページでキーボードを入力すると、JQueryのresizeイベントがトリガされますが、UICWebViewではできません。

三：SafariまたはWebviewでは、window unloadイベントはリフレッシュだけでトリガされ、ページを終了したり、他のページにジャンプしたりしてもトリガできません。

四：SafariまたはWebviewでは、まれに特殊に実現されたページクリックイベントが無効になります。

以上の問題がある場合、サfari対応行為に準じる。