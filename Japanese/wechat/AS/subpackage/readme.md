#微信のゲームは実戦に分けられます。

>author：charley

いくつかの大型ゲームにとって、微信のミニゲームの4 Mの初期パッケージははるかに足りないです。JSだけで4 Mを超えるので、2.1のミニゲームのベースライブラリが発売される前に、絶えず機能を切り続けるしかないです。JSは4 Mより小さいです。（新米があったら分かりません。なぜですか？まず基礎を調べてから本文を見に行きます。）ミニゲームの基本ライブラリは2.1バージョンからパック形式でアップロードされたパッケージを8 Mに拡大してサポートしていますが、どうやって分割しますか？

**本編では、パックの仕方だけでなく、ミニゲームについても、パックの過程でよくある問題に対して、実例のDEMOを通じて、関連した紹介を行い、開発者にミニゲームの包み方と注意事項を理解するように助けます。**



###一、本当に分けますか？

WeChatのゲームに対してパッケージを分けたり、ASのプロジェクトをどのように分けて使いますか？よく知らない開発者は、パッケージを分けて逆に困惑と障害に直面します。ですから、私たちはカバンを分けてもらう前に、自分のプロジェクトを分析しなければなりません。本当にデバッグの需要がありますか？実は今の大多数の製品にとって、カバンを分けずにオンラインでミニゲームの製品を作ることができます。

####1、UIを使ったことがありますか？それとも分離モードですか？

LayaAirエンジンの開発者で、UIはLayaAirIDEで作られることが多い。

F 9のUIモードオプションおよびプロジェクトマネージャ、各UIページを右クリックしてデフォルト属性を設定する場合のエクスポートタイプオプションは、埋め込みモード、ローディングモード、分離モードの3つのオプションが見られます。

![图1](img/1.png) 


**デフォルトは埋め込みモードです。**このようなモードでは、UIのページをエクスポートすると、設定情報などのコンテンツがプロジェクトのコードファイルとして出力されます。最終的にミニゲームとしてリリースされるのは、jsファイルです。そのため、いくつかの貴重なミニゲームのローカルパッケージのボリュームを占用しました。だから**これにより、ゲームのパッケージサイズが減少し、UIを出力するモードをロードモードまたは分離モードに変更することができます。**この2つのモードはいずれも、ページ構成情報などをJsonファイルにエクスポートします。jsonファイルは、ローカルパケット空間を占有することなく、URLを通じて遠隔的に動的にロードして使用できます。

>**Tips:**
>
>1、ロードモードと分離モードの違いは、ロードモードは全てのUIページを一つのjsonファイルにエクスポートし、分離モードは各UIページを一つの独立したjsonに導出することである。
>
>2、ロードモードと分離モードはJsonを導出するため、コードを書いてロードしてから使用することができるので注意してください。埋め込みモードは必要ありません。

つまり、ロードモードと分離モードは、パッケージJSのサイズを減らすことができる。このような方法で解決できれば、パケットで解決する必要がないかもしれません。具体的な状況はプロジェクトによって決められます。

####2、圧縮と混淆

圧縮混淆後のjsコードを通じて、パッケージ体験が著しく減少しました。JSが4 Mを超えていないなら、分けなくてもいいです。リソースなどのコンテンツは、URLを使って動的にロードできます。最初にロードすると、物理キャッシュ内に存在します。50 Mを超えない常用キャッシュ内容です。次のオープンにはロードする必要がありません。



###二、ミニゲームを勉強します。

実戦で分包する前に、公式文書を見たことがないので、必ずよく見てください。これは非常に有用です。いくら理解しても、まず文書の要点を理解してから、より良い理解ができます。リンクは下記の通りです。まず見てから後のステップを進めてください。

[https://developers.weixin.qq.com/minigame/dev/tutorial/base/subpackages.html](https://developers.weixin.qq.com/minigame/dev/tutorial/base/subpackages.html)



###三、微信のミニゲームの公式パッケージ方式

多くの開発者が公式の下請け文書を見ましたが、ここで重要なのを拾ってから渡ります。

####1、game.jsonに、パケット名とパケットパスを分けるフィールドを配置する。


```json

{
  ...
  "subpackages": [
    {
      "name": "stage1",
      "root": "stage1/" // 可以指定一个目录，目录根目录下的 game.js 会作为入口文件，目录下所有资源将会统一打包
    }, {
      "name": "stage2",
      "root": "stage2.js" // 也可以指定一个 JS 文件
    }
  ]
  ...
}
```


subpackagesには、複数のnameとrootがあります。各グループは一つのパックを表します。一つのパックは、4 Mを超えてはいけません。全部のゲームの初期パッケージは8 Mを超えてはいけません。

まず分包配置の構造と注釈説明を見て、一応理解してください。まだ分からないなら、後の実戦的な配置に合わせて理解してもいいです。

####2、ミニゲームの公式パッケージにサンプルコードをロードする

ミニゲーム公式サイトが提供されました。[wx.loadSubpackage()](https://developers.weixin.qq.com/minigame/dev/document/subpackages/wx.loadSubpackage.html)APIはパケットのダウンロードをトリガし、wx.loadSubpackageを呼び出した後、パケットのダウンロードとローディングをトリガし、ロードが完了したら、wx.loadSubpackageのsuccessフィードバックによってローディング完了を通知します。サンプルコードは以下の通りです。


```javascript

const loadTask = wx.loadSubpackage({
  name: 'stage1', // name 可以填 name 或者 root
  success: function(res) {
    // 分包加载成功后通过 success 回调
  },
  fail: function(res) {
    // 分包加载失败通过 fail 回调
  }
})
```


ロード成功と同時に、wx.loadSubpackageは一つ戻ります。[LoadSubpackageTask](https://developers.weixin.qq.com/minigame/dev/document/subpackages/LoadSubpackageTask.html)LoadSubpackage Taskを通じて現在のダウンロード進捗を取得することができます。サンプルコードは以下の通りです。


```javascript

loadTask.onProgressUpdate(res => {
  console.log('下载进度', res.progress)
  console.log('已经下载的数据长度', res.totalBytesWritten)
  console.log('预期需要下载的数据总长度', res.totalBytesExpectedToWrite)
})
```


この文書は主にパック方法と開発者がよく出会うwindowドメインによるパッケージ分けの問題を説明します。ダウンロードの進捗状況は分かりやすく、開発者のフィードバックに関する問題がないので、実戦コードでは言及していません。もしこの問題があったら、コミュニティで提出してもいいです。



 	



###四、ダウンロード例項目

私は皆さんのために簡単なサンプルを二つ用意しました。ダウンロードして解凍した後、default Demoディレクトリの下に、分割前のサンプル項目があります。subPackage Demoカタログの下に、分割後のサンプル項目があります。開発者はこの文書を読みながら、分割前と分割後の項目で差を比較して、ゲームの区切りを理解することができます。

ダウンロード先:[https://github.com/layabox/layaair-doc/raw/master/project/AS3/AS_subPackage_Demo.zip](https://github.com/layabox/layaair-doc/raw/master/project/AS3/AS_subPackage_Demo.zip)



###五、実戦でポイントを分けます。

####1、WeChat開発者ツールとリリース項目の注意

実戦パックの第一歩は、必ずWeChat開発者ツールでミニゲームを作成してください。パッケージを分けたら、ミニゲームのローディングモードを採用していますので、ブラウザーでは走れなくなります。全体のデバッグプロセスはWeChat開発者のツールで全部完了します。そこで、皆さんのために準備したサンプルをダウンロードして、先にdefault Demoのカタログの例を開いて、ミニゲームのバージョンを発表します。基礎デバッグの流れを走り通す。

>Tips：ここで注意したいのは、ダウンロードの項目は、すでに発表されていますので、デフォルトで記録されているのは以前発表されたディレクトリです。

####2、ベースライブラリバージョン

マイクロクレジット開発者のツールのデバッグベースライブラリのバージョンを確認してください。そうでないと、本文の操作に従って、デバッグのバージョンがサポートされていないので、デバッグに問題が発生します。

開発者ツールは1.02.1806120および以上のバージョンを使用します。

ベースライブラリは2..0および以上のバージョンを使用します。

この文書は2.2.0です。図1に示すように、

![图2](img/2.png) 


（図2）

####3、分割カタログの関連操作

#####game.jsonを修正します

パックを分ける前に、カタログを分けて企画し、game.jsonの中で表現します。

ここでは簡単にパッケージディレクトリbを設定します。まずdefault Demoのサンプル項目のgame.jsonを以下のコードに変更してもいいです。


```json

{
  "deviceOrientation": "landscape",
  "showStatusBar": false,
  "networkTimeout": {
    "request": 10000,
    "connectSocket": 10000,
    "uploadFile": 10000,
    "downloadFile": 10000
  },
  "subpackages": [
    {
      "name": "b",
      "root": "js/subpackage/"
    }
  ]
}
```


小さなゲームのパッケージリストを設定してから計画します。ASプロジェクトのパッケージファイルとカタログを作成します。

#####ASパケットファイルmodule.defを作成します。

はい、**プロジェクトのルートディレクトリ**を選択して、通常の空のテキストファイルを作成し、名前を付けてください。`module.def`ファイルに入力した内容は以下の通りです。


```json

module:"subpackage/b"
path:"src/subpackage"
```


**module内の値は、パケットによって生成される新しいjsの名前とパスを表しています。**上記の例では、subpackageは、パケット分けされたディレクトリ名、bはjsのファイル名であり、ディレクトリがほしくない場合は、bのみを記入すると、ディレクトリを含まないb.jsが生成されます。

ここで紹介したいのは、カタログがあるかないかにかかわらず、ここで生成されます。`bin/h5/js`目次の下。上記の例の値のように、実際に生成されたパスは`bin/h5/js/subpackage/b.js`。だからちょうど小さいゲームのgame.jsonの中で計画の道に対応します。`js/subpackage/`。

**path内の値はmodule対応のASソースファイルディレクトリを表しています。**。説明が必要なのは、パスです。`src/subpackage`複数のasファイルがあれば、各ファイル間に引用関係がある限り、同じjs内にまとめてコンパイルされます。

>moduleとpathの値は引用符に入れて、終了記号は不要ですが、必ず改行します。

#####特に重要な引用関係

パッケージのクラスを分けて、メインパッケージの中で、参照しないといけません。は、分割されたファイルはありません。`module.def`内部`path`指定されたパス内のコードをコンパイルします。`module`指定されたディレクトリとファイルにあります。パケット分けとパケット分けの間にも、現在のコードが使われているかどうかに関わらず。引用しなければなりません。

例えば、例示的な項目では、subpackageパッケージ内のbクラスを導入する。


```typescript

import subpackage.b;
```





 



####4、分包コードの使用

前のステップでデバッグファイルとディレクトリの作成と企画を完了したら、デバッグコードを開始することができます。

まず原則として、下請けをするなら**メインパッケージとサブパッケージの論理的な関連性は、できるだけ少なければ良いです。**。

もう一つ言わなければならないのは、TSとJSはそれぞれwindowドメインに対してプロジェクト改造を行います。ASはwindowドメインに対して修正をする必要がありません。LayaAirエンジンの下請けルールに従って処理すればいいです。

そこで、カバンの種類と方法について重点的に説明します。パケット分割の例としては、私が提供したサンプルのDEMOを直接ダウンロードすることができます。


```javascript

//图集加载后回调
private function onLoaded():void
{

    showUI(aUI);
	//微信小游戏官方提供的分包加载方法
    const loadTask = __JS__('wx').loadSubpackage({
        name: 'b', // name 可以填 name 或者 root
        success: function(res) {
            // 分包加载成功后通过 success 回调
            console.log("success");

            //实例化分包的类
            b = __JS__('new subpackage.b()');

            //把实例化的UI传给分包的类
            b.newUI = newUI;

            //初始化分包，监听按钮事件
            b.init();
        },
        fail: function(res) {
            // 分包加载失败通过 fail 回调
            console.log("fail");
        }
    });

}
```


この方法を見にきました。showUIを呼び出してUIを表示した後、微信小ゲーム公式が提供するパッケージロード方法を直接使いました。パッケージのロードに成功した後、successのコールバック方法で、私達は通過を開始します。`__JS__（'new subpackage.b()'）；`パッケージ内を実装する方法を示します。ここではなぜJSの方法で実例を示していますか？パケット分けの内容をそのまま使っていますので、コンパイルした後、異なるjsに分けられています。同じファイルでないと対応するクラスが見つからないので、エラーが発生します。だから、分けて包む種類と方法を使って、必ず使わなければなりません。`__JS__（'XXX'）；`xxxはjsコードです。

####5、まとめてみます

ASプロジェクトの下請けは、実際には公式の例をもとに、ASプロジェクトの下請けを使えばいいです。以前からパックを分けていた開発者にとって、ASのミニゲームのパックはとてもスムーズです。だから、本編は実はミニゲームと結合して、ASプロジェクトをどうやって分けますか？

**ASパックのポイントを振り返ってみます。**:

1、プロジェクトのルートディレクトリでmodule.defファイルを作成する。

2、正しい分割後経路とjsファイル名（module）と正しい対応ソースファイル経路（path）を記入する。

3、分包コードファイルを作成し、分包符号化を行う。

4、メインパッケージ内でパケットのクラスを参照する。



###六、開発者の実戦提案

開発者はまず私が与えたサンプル項目を分けて試してもいいです。問題があれば、この文書を見てもいいです。そして、私が与えた二つの例示的な項目の違いを比べてもいいです。まずはWeChatで走ります。本当の理解は分包してから、自由な実戦ミニゲームを行います。問題があったら、問題をコミュニティに送ってください。そして問題の中でデモのプロジェクトをアップロードしてください。

その後、開発者がカバンを分けていることに気づいたら、新しい問題に直面しています。を選択します



##この文章は賞賛します

本論文があなたのために役立つと思ったら、スキャンコードの作者への賞賛を歓迎します。激励は私たちがより多くの優れた文書を書くための動力です。

![wechatPay](../../../wechatPay.jpg)