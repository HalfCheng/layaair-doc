# 播放动画

###### *version :2.1.0beta   Update:2019-6-13*

####アニメーションコンポーネントを取得

エクスポート後のリソースをアイテムにコピーします。`bin/res`ディレクトリでは、コードを使ってキャラクターリソースをロードします。シーンに直接読み込むと、動画が自動的に再生されます。アニメの放送はどうやってコントロールしますか？

LayaAir 3 DエンジンのSprite 3 Dクラスが提供されました。`getComponent()`方法を使用してモデル上のコンポーネントを取得します。動画付きモデルは、ロード作成時にデフォルトでアニメイトに付与されていますので、以下のコードを参照してください。


```typescript

//获取角色动画组件
var ani= role3D.getChildAt(0).getComponent(Laya.Animator);
```


開く.lhファイルを見ると、アニメーションコンポーネントはモデルのサブオブジェクトに結合されていますので、使用しました。`getChildAt(0)`を選択して、サブオブジェクトモデルを取得します。そして通過します`getComponent(Laya.Animator)`を選択します。

**Tips：場合によっては.lhまたは.lsファイルには複数の親子レベルの関係が存在しています。アニメーションコンポーネントはすべて第1の階層にあり得ません。第2の層かもしれません。第3の層かもしれません。アニメーションコンポーネントの階層については、美術との事前の約束が多い。階層を確認したらget ChildAt()、またはget ChildByName()などの方法でモデルを取得してからアニメーションコンポーネントを取得することができます。**

もう一つの代替案があります。アニメーションコンポーネントを取得する前に、lsまたはlhはアニメーションコンポーネントモデルの階層関係を調べて、モデルとアニメーションコンポーネントを取得します。

####コントロール

アニメーションのセットを手に入れたら、どのように一つの動作だけを再生しますか？動作の制御と切り替えを実現する方法は二つあります。

また、この例では、unityではアニメーションを分離していません。モデルのデフォルトアニメーションを使用しています。**Take 001**プラグインはアニメーション解析ファイルを一つだけエクスポートしました。

そのため、あるアニメーションの再生を制御し、コードにカスタムアニメーションクリップを追加し、アニメーションクリップに開始と終了フレームレートを設定して実現する必要がある。

アニメーションのセットを見てください。`play() `方法、具体的な方法のパラメータは以下の通りです。

！[](img/1.png)<br/>(図1)

アニメーションを再生する場合、あるフレームからあるフレームには、既存のアニメーションをベースに、アニメーション状態を追加する（クリップ）を作成することができます。`AnimatorState`最新のアニメイト類が提供されました。`addState() `例示的な方法では、開発者がアニメーションクリップを作成し、名前を定義して、プレイ（アニメーションクリップ名）方法で再生することができます。これらを知ったら、アニメを放送します。コードは以下の通りです

**アニメーションがループされているかどうかは、unityエディタのアニメーション属性にチェックを付けることができます。エクスポート後、エンジンは設定に従ってアニメーションを再生します。図5、6のloop Time選択ボックスを参照してください。アニメーション状態を作成するか、isliooping属性をtrueとします。**


```typescript

//获取精灵
var monkey = Laya.Loader.getRes("res/threeDimen/skinModel/LayaMonkey/LayaMonkey.lh") as Laya.Sprite3D;

this.scene.addChild(monkey);
//获取角色动画组件
var ani = monkey.getChildAt(0).getComponent(Laya.Animator) as Laya.Animator;
//创建一个动画动作状态
var state1 = new Laya.AnimatorState();
//设置动作状态的名称
state1.name = "hello";
//设置动作状态播放的起始时间（起始时间与结束时间的设置为0-1的百分比数值）  要截取的时间点 / 动画的总时长
state1.clipStart = 10/40;
//设置动作状态播放的结束时间
state1.clipEnd = 20/40;
//得到默认动画赋值给Clip（getDefaultState默认动画为Unity中animation的数组顺序0下标的动画）
state1.clip = ani.getDefaultState().clip;
//动画播放是否循环
state1.clip.islooping = true;
//添加动画状态到动画组件里
this.ani.addState(state1);
//播放动画
this.ani.play("hello");
```


コンパイル運転後の効果は以下の通りです。10-20フレームのスタンディング動画クリップだけを循環して再生しました。

！[](img/2 gif)<br/>(図2)

####Unityで定義されたアニメーションクリップ再生

unityでは、アニメーションをセグメント化し、クリップのセグメントを名前にすることができます。エクスポートされたリソースは、コントロール時に、名前でアニメーションに切り替わり、開発者たちが使いやすいです。（このような方法では、リソースのエクスポート時にアニメーション解析ファイルを追加し、Httpアクセス回数を増やすために、どのような方法で開発者が実際の状況に応じて選択できますか？）

unityにおけるアニメーションセグメントの区分方法は以下の通りである。

1）「リソースマネージャ」でモデルファイルを選択し、右側にあります。**inspector**画面で選択**アニメイト**を選択して、デフォルトのアニメーションが表示されます。**Take 001**をクリックして、ユーザー定義の名前を編集し、プラス記号をクリックしてアニメーションセグメントを追加し、セグメントの開始と終了フレームを変更することができます。

Tips：ゲーム中に動画を循環したいなら、下記の図にチェックしてください。**ループTime**を選択します。

！[](img/3 png)<br/>(図3)

この例では全部で4つの動作が、美術によって提供されるアニメーションフレーム数に応じて4つのアニメーションセグメントに追加されるように修正される（図4）。

！[](img/4 png)<br/>(図4)

修正が完了すると、リソースマネージャモデルにも対応するアニメーションファイルが追加されますので、アニメーションコントローラを変更して、新しく生成したアニメーションセグメントをアニメーションコントローラに追加します。そうでないと、完全なアニメーションリソース解析ファイルをエクスポートできません。

！[](img/5 png)<br/>(図5)

前のステップを完了したら、再エクスポートし、出力されたリソースにも4つのlaniアニメーション解析ファイルが生成されます。

例コードを修正して、動画名の再生方式を適用します。


```typescript

onComplete(){
//.................
		var monkey = Laya.Loader.getRes("res/threeDimen/skinModel/LayaMonkey/LayaMonkey.lh") as Laya.Sprite3D;
        //加载到场景
       	scene.addChild(monkey);
        //让摄影机指向角色
        camera.transform.lookAt(monkey.transform.position,new Laya.Vector3(0,1,0));
    	//获取动画组件
    	var ani = monkey.getComponent(Laya.Animator) as Laya.Animator;
		//播放攻击状态
        ani.play("attack");
		//等待动画播放完成
        Laya.timer.frameLoop(1,this,function(){
            //如果当前播放state已经播放完了一次
            if(ani.getCurrentAnimatorPlayState().normalizedTime >= 1){
                //回到站立状态
                ani.play("stand");
            } 
        });
}

```


！[](img/6.gif)<br/>(図6)
